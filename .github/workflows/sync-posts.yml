name: Sync Posts

on:
  push:
    branches:
      - main
    paths:
      - 'ObsidianVault/posts/**'  # Only trigger on changes to posts
  workflow_dispatch:  # Allow manual triggering

permissions:
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3  # Updated to v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v3  # Updated to v3
        with:
          node-version: '18'
          cache: 'npm'  # Enable npm caching

      - name: Install dependencies
        run: npm ci  # Use ci instead of install for cleaner installs

      - name: Run sync script
        run: |
          echo "Running sync script..."
          npm run sync-posts
          echo "Sync completed"

      - name: Check for changes
        id: check_changes
        run: |
          git status
          git diff --quiet && git diff --staged --quiet && echo "::set-output name=changes::false" || echo "::set-output name=changes::true"

      - name: Commit changes
        if: steps.check_changes.outputs.changes == 'true'
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add .
          git commit -m "chore: sync blog posts [skip ci]"
          git push

      - name: Deploy to Vercel
        if: success()
        id: deploy
        run: |
          echo "Triggering Vercel deployment..."
          DEPLOY_RESULT=$(curl -X POST "${{ secrets.VERCEL_DEPLOY_HOOK_URL }}" -H "Content-Type: application/json")
          echo "Deployment triggered: $DEPLOY_RESULT"
          
          # Wait for deployment to start
          echo "Waiting for deployment to start..."
          sleep 15
          
          # Check deployment status
          echo "Checking deployment status..."
          STATUS_CODE=$(curl -s -o /dev/null -w "%{http_code}" "${{ secrets.VERCEL_SYNC_URL }}")
          echo "Deployment status code: $STATUS_CODE"
          
          if [ "$STATUS_CODE" = "200" ] || [ "$STATUS_CODE" = "404" ]; then
            echo "Deployment triggered successfully"
          else
            echo "Deployment may have failed. Status code: $STATUS_CODE"
            exit 1
          fi 